#!/bin/bash

set -e

# Figure out where Pegasus is installed
export PEGASUS_BIN_DIR=`pegasus-config --bin`
if [ "x$PEGASUS_BIN_DIR" = "x" ]; then
    echo "Please make sure pegasus-plan is in your path"
    exit 1
fi

echo "Planning workflow..."
./plan.sh


RUN_DIR=$(find submit -name 'run00*' | sort -n | tail -1)
RUN_DIR=$(cd $RUN_DIR && pwd)
echo "RUN_DIR is $RUN_DIR"

echo "Running PMC..."
mpiexec -n 4 $PEGASUS_BIN_DIR/pegasus-mpi-cluster --monitord-hack --max-wall-time 5 $RUN_DIR/pmc-only-0.dag
RC=$?
if [ $RC -ne 0 ]; then
    exit $RC
fi

echo "Running monitord..."
pegasus-monitord -n -r $RUN_DIR/pmc-only-0.dag.dagman.out

exit $?
