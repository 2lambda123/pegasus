#!/bin/bash

set -e

# Figure out where Pegasus is installed
export PEGASUS_BIN_DIR=`pegasus-config --bin`
if [ "x$PEGASUS_BIN_DIR" = "x" ]; then
    echo "Please make sure pegasus-plan is in your path"
    exit 1
fi

echo "Planning workflow..."
./plan.sh

echo "Running PMC..."
RUN_DIR=$(find work -name 'run00*' | sort -n | tail -1)
mpiexec -n 4 $PEGASUS_BIN_DIR/pegasus-mpi-cluster --jobstate-log --per-task-stdio --max-wall-time 5 $RUN_DIR/pmc-only-0.pmc

exit $?
