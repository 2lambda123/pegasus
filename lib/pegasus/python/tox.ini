[tox]

; Test for py26, py27, py35, py36, py37, py38
envlist  = py35


[testenv]

commands     = pytest --junit-xml test-reports/pyunit.xml --cov Pegasus --cov-report term --cov-report html --no-cov-on-fail --cov-fail-under 22 {posargs:Pegasus/test}

passenv      =
    USER
    CPATH

setenv       =
    PYTHONUNBUFFERED = yes
    PYTHONHASHSEED   = 3104489401

skip_install = {env:SKIP_INSTALL:False}

deps         =
    pytest
    pytest-mock
    coverage
    pytest-cov
    jsonschema
    pyOpenSSL


[testenv:py26]

deps =
    pytest==3.2.5
    pyOpenSSL==0.14


[testenv:lint]

basepython              = python3.6

skipsdist               = True

skip_install            = True

autoflake-ci-true-args  =
autoflake-ci-false-args = --in-place

isort-ci-true-args      = --check-only --diff
isort-ci-false-args     = --apply

black-ci-true-args      = --check --diff
black-ci-false-args     =

whitelist_externals     = cd

commands                =
    autoflake --recursive --remove-unused-variables --remove-duplicate-keys --remove-all-unused-imports --ignore-init-module-imports {[testenv:{envname}]autoflake-ci-{env:CI:false}-args} {toxinidir}
    # .. note:: cd {toxinidir} before isort is needed, as tox invokes isort with it's absolute path, i.e. `pwd`/.tox/env/isort versus just isort, so isort does not pick up the config properly.
    cd {toxinidir} && isort --recursive {[testenv:{envname}]isort-ci-{env:CI:false}-args} {toxinidir}
    black --target-version py35 {[testenv:{envname}]black-ci-{env:CI:false}-args} {toxinidir}
    flake8 --exit-zero {toxinidir}

deps                    =
    autoflake
    isort
    black
    flake8
    flake8-bugbear
    flake8-docstrings


[testenv:docs]

changedir           = ../../../doc/docbook

whitelist_externals = make

commands_pre        =
    sphinx-apidoc     --force  --output-dir python {toxinidir}              {toxinidir}/{setup,test}.py {toxinidir}/Pegasus/{cluster,command,compat,exitcode,init,s3,submitdir,user}.py {toxinidir}/Pegasus/{test,db,monitoring,catalogs,cli,netlogger,plots_stats,service,tools}
    javasphinx-apidoc --update --output-dir java   {toxinidir}/../../../src {toxinidir}/../../../src/edu/isi/pegasus/aws/batch/common/

commands            = make html man

skipsdist           = True

skip_install        = True

deps                =
    sphinx
    recommonmark
    sphinx_rtd_theme
    sphinxcontrib-openapi
    javasphinx
    sphinx_tabs


[coverage:run]

omit = Pegasus/test/*
